{% extends "base.html" %}
{% block content %}

<div class="jumbotron">
    <h3 class="text-center">Experiment Result</h3>
    <div class="row">
        <div class="col-md-6">
            <h3 class="text-center">Experiment Info</h3>
            <div class="container">
                <div class="row">
                    <p class="col-md-5 font-weight-bold">Id</p>
                    <p class="col-md-7">{{ experiment.id }} </p>
                </div>
                <div class="row">
                    <p class="col-md-5 font-weight-bold">Dataset</p>
                    <p class="col-md-7">{{ experiment.data }} </p>
                </div>
                <div class="row">
                    <p class="col-md-5 font-weight-bold">Algorithm</p>
                    <p class="col-md-7">{{ name }} </p>
                </div>
                <h5 class="text-center">Algorithm Parameters</h5>
                {% for i in dict_config %}
                    {% if i != "base_estimator" %}
                        <div class="row">
                            <p class="col-md-5 font-weight-bold" data-toggle="tooltip" title="{{ conf[i]['help'] }}">{{ i }}</p>
                            <p class="col-md-7">{{ dict_config[i] }} </p>
                        </div>
                    {% endif %}
                {% endfor %}
                <div class="row">
                    <div class="col-md-3">
                            <a class="btn btn-primary btn-block" role="button" href={{ url_for("experiments.new_experiment") }}?exp={{experiment.id}} >Reuse</a>
                    </div>
                {% if experiment.state == 1 %}
                    <div class="col-md-6">
                        <a class="btn btn-primary btn-block" role="button" href={{url_for("experiments.download_model",id=experiment.id)}} >Download model</a>
                    </div>
                    <div class="col-md-3">
                        <a class="btn btn-primary btn-block" role="button" href={{url_for("experiments.predict",id=experiment.id)}}>Predict</a>
                    </div>
                {% endif %}
                </div>    
            </div>
        </div>
        <div class="col-md-6">
            {% if experiment.state == 0 %}
                <h3 class="text-center">In Progress</h3>
                <img src="{{ url_for("static",filename="img/dude-mining.gif") }}"/>
            {% else %}

                {% if experiment.state == 2  %}
                    <h3 class="text-center">Error</h3>
                    <p class="text-danger" ><i class="material-icons" >
                        error
                        </i>{{ experiment.result }}</p>
                {% elif experiment.state == 1 %}
                    <h3 class="text-center">Finished</h3>
                    <div class="container-fluid" id="success_result">
                    
                    </div>
                {% endif %}                

            {% endif %}
        </div>
    </div>
</div>

{% endblock %}
{% block js %}
<script src="{{ url_for('static', filename="js/config_alg.js") }}"></script>
<script>
    {% if experiment.state == 1 %}
        to_render = [];
        $("document").ready(function(){
            result = {{ experiment.result|safe  }};

            var place_in = $("#success_result");
            place_in.html("");
            var parameters = Object.keys(result);
            var row_number = 0;
            parameters.forEach(function(i){
                row_number += 1;
                let parameter = result[i];
                let row = $("<div></div>", {class: "row"});
                let block = $("<div></div>", {id: i, class: "col-12"});
                if (row_number%2 == 1){
                    block.addClass("row-odd");
                }
                row.append(block);
                block.html("<label for=\""+i+"_value"+"\">"+
                                i+
                            "</label>");
                block.append($("<a onClick=\"toggle_click('"+i+"_chart"+"','"+i+"_not_exists"+"')\" href=\"#a\" id=\""+i+"_open"+"\">"+
                                    "<i class=\"material-icons\" style=\"float: right;\">"+
                                        "arrow_drop_down_circle"+
                                    "</i>"+
                            "</a>"));

                
                let nav = $("<ul></ul>", {class: "nav nav-tabs"})
                let super_div = $("<div></div>", {class: "tab-content"})

                for(let z=0; z<result[i].length; z++){
                    let li = $("<li></li>");
                    li.append($("<a></a>", {"data-toggle": "tab", href: "#"+i+"-"+z+"_tab",
                                            class: "nav-link", id: i+"-"+z+"_tab-tab",
                                            "aria-controls": i+"-"+z+"_tab"}));
                    let a = $(li.children()[0]);
                    a.text("k"+z);
                    let tab_pane_div = $("<div></div>",{class: "tab-pane fade",
                                                        id: i+"-"+z+"_tab", role: "tabpanel",
                                                        "aria-labelledby": i+"-"+z+"_tab-tab"});
                    let tab_container_div = $("<div></div>", {class: "container-fluid"});
                    tab_pane_div.append(tab_container_div);
                    let div = $("<div></div>", {class: "row"});
                    if(z == 0){
                        tab_pane_div.addClass("active");
                        tab_pane_div.addClass("show");
                        a.addClass("active");
                        a.attr("aria-selected", true);
                    }
                    let result_val = result[i][z];
                    switch(i){
                        case "AUC":
                        result_val = 1-result_val;
                        case "max_error":
                        case "mean_score_error":
                        case "mean_absolute_error":
                        case "kappa":
                        case "accuracy":
                        case "f1_score":
                            let k = $("<p></p>", {class: "col-md-5 font-weight-bold"});
                            let v = $("<p></p>", {class: "col-md-7"});
                            k.text("Value:");
                            v.text(result_val);
                            div.append(k, v);
                            break;
                        case "ROC":
                            let label = "AUC="+(1-result["AUC"][z]);
                            var canvas = $("<canvas></canvas>", {id:i+"_canvas", width: "100%"});
                            var ctx = canvas.get(0).getContext('2d');
                            
                            var myChart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    datasets: [{
                                        label: label,
                                        data: x_y_convert(result_val),
                                        backgroundColor: convertHex(GLOBAL_STYLE.getPropertyValue('--primary'),50),
                                        borderColor: GLOBAL_STYLE.getPropertyValue('--primary'),

                                    }]
                                },
                                options: {
                                    elements: {
                                        point: {
                                            radius: 0
                                        }
                                    },                                
                                    scales: {
                                        xAxes: [{
                                            type: "linear"
                                        }],
                                        yAxes: [{
                                            ticks: {
                                                beginAtZero: true
                                            }
                                        }]
                                    }
                                }
                            })
                            div.append(canvas);
                            break;
                        case "confussion_matrix":
                            var canvas = $("<div></div>", {id:i+"_canvas", width: "100%"});
                            let opt = {
                                chart: {
                                    type: "heatmap"
                                },
                                dataLabels: {
                                    style: { colors: ["black"]}
                                },
                                colors: [$.trim(GLOBAL_STYLE.getPropertyValue('--primary'))],
                                series: get_series(result_val),
                                xaxis: {
                                    labels: {
                                        show: false
                                    }
                                },
                                yaxis: {
                                    show: false
                                },
                                plotOptions: {
                                    heatmap: {
                                        distributed: true
                                    }
                                }
                            }
                            var chart = new ApexCharts(canvas.get(0), opt);
                            to_render.push(chart);
                            div.append(canvas);
                            break;                  
                    }
                    nav.append(li);
                    tab_container_div.append(div);
                    super_div.append(tab_pane_div);
                }
                let super_container = $("<div></div>", {class: "tabs-container col-12", id: i+"_chart", style: "display: none;"});
                super_container.append(nav);
                super_container.append(super_div);
                row.append(super_container);
                place_in.append(row);
            });
            to_render.forEach(function(e){
                e.render();
            });
        });
    {% endif %}

    function x_y_convert(xy){
        let data = [];
        for(let i=0; i<xy[0].length; i++){
            data.push({x: xy[1][i],y:xy[0][i]});
        }
        return data;
    }
    function convertHex(hex,opacity){
        hex = hex.replace('#','');
        r = parseInt(hex.substring(0,2), 16);
        g = parseInt(hex.substring(2,4), 16);
        b = parseInt(hex.substring(4,6), 16);

        let result = 'rgba('+r+','+g+','+b+','+opacity/100+')';
        return result;
    }

    function get_series(matrix){
        let data = [];
        for(let i=matrix.length-1; i>=0; i--){
            data.push({data: matrix[i]});
        }
        return data;
    }
    
</script>
{% endblock %}