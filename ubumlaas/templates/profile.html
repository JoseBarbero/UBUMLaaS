{% extends "admin/admin_base.html" %}

{% block content %}

<main class="content">
    <div class="container-fluid p-0">

        <div class="mb-3">
            <h1 class="h3 d-inline align-middle"><strong>Profile</strong></h1>
        </div>
        <div class="row">
            <div class="col-md-4 col-xl-3">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Profile Details</h5>
                    </div>
                    <div class="card-body text-center">
                        {% for category, message in get_flashed_messages(with_categories=True) %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">{{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        {% endfor %}
                        <img src="avatar.jpg" alt="{{ user.username }}" class="img-fluid rounded-circle mb-2"
                            width="128" height="128" />
                        <h5 class="card-title mb-0">{{ user.username }}</h5>
                        <div class="text-muted mb-2">{{ user.email }}</div>
                        {% if user.user_type == 0 %}
                        <h5 class="card-title mb-0">Admin</h5>
                        {% endif %}
                        <a href="#" class="badge bg-success me-1 my-1">Statistics</a>
                    </div>
                    <hr class="my-0" />
                    <div class="card-body">
                        <h5 class="h6 card-title">About</h5>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-1"><span data-feather="box" class="feather-sm me-1"></span> App usage to <a>{{ user.desired_use }}</a></li>
                            <li class="mb-1"><span data-feather="home" class="feather-sm me-1"></span> Lives in <a>{{ user.country }}</a></li>
                            {% if user.institution %}
                            <li class="mb-1"><span data-feather="briefcase" class="feather-sm me-1"></span> Works at <a>{{ user.institution }}</a></li>
                            {% endif %}
                            {% if user.website %}
                            <li class="mb-1"><span data-feather="bookmark" class="feather-sm me-1"></span><a href="{{ user.webpage }}">Personal blog</a></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% if user.twitter or user.github or user.linkedin or user.google_scholar %}
                        <hr class="my-0" />
                        <div class="card-body">
                            <h5 class="h6 card-title">Elsewhere</h5>
                            <ul class="list-unstyled mb-0">
                                {% if user.twitter %}
                                <li class="mb-1"><span data-feather="twitter" class="feather-sm me-1"></span><a href="https://twitter.com/{{ user.twitter }}">Twitter</a></li>
                                {% endif %}
                                {% if user.github %}
                                <li class="mb-1"><span data-feather="github" class="feather-sm me-1"></span><a href="https://github.com/{{ user.github }}">GitHub</a></li>
                                {% endif %}
                                {% if user.linkedin %}
                                <li class="mb-1"><span data-feather="linkedin" class="feather-sm me-1"></span><a href="https://linkedin.com/in/{{ user.linkedin }}">Linked-In</a></li>
                                {% endif %}
                                {% if user.google_scholar %}
                                <li class="mb-1"><span data-feather="paperclip" class="feather-sm me-1"></span><a href="{{ user.google_scholar }}">Google Scholar</a></li>
                                {% endif %}
                            </ul>
                        </div>
                    {% endif %}
                    <hr class="my-0" />
                    <div class="text-center">
                        <a id="editProfile" class="badge bg-warning me-1 my-1" type="button" data-toggle="modal" data-target="#formEditProfile">Edit Profile</a>
                    </div>
                </div>
            </div>
            <div class="col-md-8 col-xl-9">
                <!-- <div class="row flex-fill collapse">
                    <div class="card flex-fill">
                        hola
                    </div>
                </div> -->
                <div class="card flex-fill">
                    <div class="card-header" data-toggle="collapse" data-target="#datasets_table">
                        <i class="fa fa-chevron-down pull-right"></i>
                        <h5 class="card-title mb-0">Datasets</h5>
                    </div>
                    <div id="datasets_table" class="card-body collapse">
                        <div class="row justify-content-center">
                            <div class="col-xl-11">
                                <div class="table-responsive">
                                    <table id="datasetsTable" style="width:100%" data-pagination="true" data-search="true"
                                        data-filter-control="true" data-show-search-clear-button="true" data-page-size="5"
                                        data-page-list="[5, 10, 25, 50, 100, all]">
                                        <thead>
                                            <tr>
                                                <th data-sortable="true" class="d-none d-xl-table-cell">#</th>
                                                <th data-sortable="true" class="d-none d-xl-table-cell">Name</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for d in datasets %}
                                            <tr>
                                                <td class="d-none d-xl-table-cell">{{ loop.index }}</td>
                                                <td class="d-none d-xl-table-cell">{{ d }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card flex-fill">
                    <div class="card-header" data-toggle="collapse" data-target="#experiments_table">
                        <i class="fa fa-chevron-down pull-right"></i>
                        <h5 class="card-title mb-0">Latest Experiments</h5>
                    </div>
                    <div id="experiments_table" class="card-body collapse show">
                        <div class="row justify-content-center">
                            <div class="col-xl-11">
                                <div class="table-responsive">
                                    <table id="experimentsTable" style="width:100%" data-pagination="true" data-search="true"
                                        data-filter-control="true" data-show-search-clear-button="true"
                                        data-sort-name="Id" data-sort-order="desc" data-page-size="15"
                                        data-page-list="[5, 10, 25, 50, 100, 250, 500, 1000, all]">
                                        <thead>
                                            <tr>
                                                <th data-sortable="true" class="d-none d-xl-table-cell" data-align="center" data-field="Id">Id</th>
                                                <th data-sortable="true" class="d-none d-xl-table-cell" data-align="center">Algorithm</th>
                                                <th data-sortable="true" class="d-none d-xl-table-cell" data-align="center">Dataset</th>
                                                <th data-sortable="true" class="d-none d-xl-table-cell" data-align="center">Init Date</th>
                                                <th data-sortable="true" class="d-none d-xl-table-cell" data-align="center">Finish Date</th>
                                                <th data-sortable="true" class="d-none d-xl-table-cell" data-align="center">State</th>
                                                <th data-sortable="false" class="d-none d-xl-table-cell" data-align="center">View Result</th>
                                                <th data-sortable="false" class="d-none d-xl-table-cell" data-align="center">Reuse</th>
                                                <th data-sortable="false" class="d-none d-xl-table-cell" data-align="center">Delete</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for e in experiments %}
                                            <tr>
                                                <td class="d-none d-xl-table-cell">{{ e.id }}</td>
                                                <td class="d-none d-xl-table-cell">{{ e.web_name }}</td>
                                                <td class="d-none d-xl-table-cell">{{ e.data }}</td>
                                                <td class="d-none d-xl-table-cell">{{ e.starttime }}</td>
                                                <td class="d-none d-xl-table-cell">
                                                    {% if e.endtime %}
                                                        {{ e.endtime }}
                                                    {% else %}
                                                        ---
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if e.state == 0 %}
                                                    <span class="badge bg-warning">In progress...</span>
                                                    {% elif e.state == 1 %}
                                                    <span class="badge bg-success">Finalized</span>
                                                    {% else %}
                                                    <span class="badge bg-danger">Error</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a class="btn btn-lg btn-info text-uppercase font-weight-bold" data-toggle="tooltip" data-placement="top"
                                                        title="See configuration and results." href="{{ url_for("experiments.result_experiment",id=e.id) }}">See</a>
                                                </td>
                                                <td>
                                                    <a class="btn btn-lg btn-warning text-uppercase font-weight-bold" data-toggle="tooltip" data-placement="top"
                                                        title="Create a new experiment with this configuration." href="{{ url_for("experiments.new_experiment", exp=e.id) }}">Reuse</a>
                                                </td>
                                                <td>
                                                    <a class="btn btn-lg btn-danger text-uppercase font-weight-bold" data-toggle="tooltip" data-placement="top"
                                                        title="Delete this experiment, its results and the model generated"
                                                        href="javascript:delete_experiment({{e.id}})">Delete</a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="formEditProfile" tabindex="-1" role="dialog" aria-labelledby="formModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title" id="formModalLabel">Edit your data, {{ user.username }}</h3>
                        <button type="button" class="close" data-dismiss="modal" aria-label="close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <form id="formUserData" method="POST">
                        {{form.hidden_tag()}}
                        <div class="modal-body">
                            <div class="form-group row">
                                <label for="password" class="col-sm-6 col-form-label">
                                    {{form.update_checkbox.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {{form.update_checkbox(onchange="allowForm('update_checkbox')")}}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="username" class="col-sm-6 col-form-label">
                                    {{form.username.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {{form.username(class="form-control", value=user.username) }}<br>
                                    {% for error in form.username.errors %}
                                    <div class="alert alert-warning alert-dismissible fade show" role="alert">{{ error }}
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="email" class="col-sm-6 col-form-label">
                                    {{form.email.label(class="control")}}
                                </label>
                                <div class="col-sm-6">
                                    {{form.email(type="email", class="form-control", value=user.email)}}<br>
                                    {% for error in form.email.errors %}
                                    <div class="alert alert-warning alert-dismissible fade show" role="alert">{{ error }}
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="country" class="col-sm-6 col-form-label">
                                    {{form.country.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {{form.country(type="country", class="form-control", value=user.country)}}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="desired_use" class="col-sm-6 col-form-label">
                                    {{form.desired_use.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {{form.desired_use(type="desired_use", class="form-control", value=user.desired_use)}}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="website" class="col-sm-6 col-form-label">
                                    {{form.website.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {% if user.website %}
                                        {{form.website(type="website", class="form-control", value=user.website)}}
                                    {% else %}
                                        {{form.website(type="website", class="form-control")}}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="twitter" class="col-sm-6 col-form-label">
                                    {{form.twitter.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {% if user.twitter %}
                                    {{form.twitter(type="twitter", class="form-control", value=user.twitter)}}
                                    {% else %}
                                    {{form.twitter(type="twitter", class="form-control")}}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="github" class="col-sm-6 col-form-label">
                                    {{form.github.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {% if user.github %}
                                    {{form.github(type="github", class="form-control", value=user.github)}}
                                    {% else %}
                                    {{form.github(type="github", class="form-control")}}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="institution" class="col-sm-6 col-form-label">
                                    {{form.institution.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {% if user.institution %}
                                    {{form.institution(type="institution", class="form-control", value=user.institution)}}
                                    {% else %}
                                    {{form.institution(type="institution", class="form-control")}}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="linkedin" class="col-sm-6 col-form-label">
                                    {{form.linkedin.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {% if user.linkedin %}
                                    {{form.linkedin(type="linkedin", class="form-control", value=user.linkedin)}}
                                    {% else %}
                                    {{form.linkedin(type="linkedin", class="form-control")}}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="google_scholar" class="col-sm-6 col-form-label">
                                    {{form.google_scholar.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {% if user.google_scholar %}
                                    {{form.google_scholar(type="google_scholar", class="form-control", value=user.google_scholar)}}
                                    {% else %}
                                    {{form.google_scholar(type="google_scholar", class="form-control")}}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <h6 class="text-muted">
                                Keep in mind that submiting this form will update ALL your data with the data on each field.
                            </h6>
                            {{form.submit(class="btn btn-primary", value="Update my data")}}
                        </div>
                    </form>
                    <div class="modal-footer"></div>
                    <form id="formUserPasswd" method="POST">
                        {{pass_form.hidden_tag()}}
                        <div class="modal-body">
                            <div class="form-group row">
                                <label for="password" class="col-sm-6 col-form-label">
                                    {{pass_form.pass_checkbox.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {{pass_form.pass_checkbox(onchange="allowForm('pass_checkbox')")}}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="password" class="col-sm-6 col-form-label">
                                    {{pass_form.password.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {{pass_form.password(type="password", class="form-control")}}<br>
                                    {% for error in pass_form.password.errors %}
                                    <div class="alert alert-warning alert-dismissible fade show" role="alert">{{ error }}
                                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="confirm_password" class="col-sm-6 col-form-label">
                                    {{pass_form.confirm_password.label(class="form-group")}}
                                </label>
                                <div class="col-sm-6">
                                    {{pass_form.confirm_password(type="password", class="form-control")}}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            {{pass_form.submit(class="btn btn-primary", value="Update my password")}}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

{% endblock content%}

{% block js %}
<script>
    const pass_fields = ['password', 'confirm_password'];
    const data_fields = ['username', 'email', 'desired_use', 'country',
                         'website', 'twitter', 'github', 'institution', 
                         'linkedin', 'google_scholar'];
    $('#formEditProfile').appendTo("body") 
    $(function () {
        $('#datasetsTable').bootstrapTable({
            silentSort: false,
            undefinedText: 'N/A'
        });
        $('#experimentsTable').bootstrapTable({
            silentSort: false,
            undefinedText: 'N/A'
        });
    })

    function allowForm(type, def=false) {
        var checked = document.getElementById(type).checked;
        if (type == 'update_checkbox') 
            fields = data_fields;
        else
            fields = pass_fields;
        
        fields.forEach(element => {
            if (checked || def)
                document.getElementById(element).disabled = false;
            else
                document.getElementById(element).disabled = true;
        });
    }
    allowForm('update_checkbox');
    allowForm('pass_checkbox');


    function delete_experiment(id) {
        $.ajax({
            url: '{{url_for("experiments.remove_experiment")}}',
            type: 'DELETE',
            contentType: 'text/plain; charset=utf-8',
            data: id.toString(),
            success: function (result) {
                location.reload()
            },
            error: function (result) {
                alert("Delete Failed");
            }
        });
    }
</script>
{% endblock js %}