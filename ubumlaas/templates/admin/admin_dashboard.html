{% extends "admin/admin_base.html" %}

{% block content %}
<!--<link href='{{ url_for("static", filename="css/admin-dash.css")}}' rel="stylesheet">-->
<main class="content">
    <div class="container-fluid p-0">

        <h1 class="h3 mb-3"><strong>Analytics</strong> Dashboard</h1>

        <div class="row d-flex">
            <div class="col-xl-12 col-xxl-5 d-flex">
                <div class="w-100">
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col mt-0">
                                            <h5 class="card-title">Experiments</h5>
                                        </div>
                                        <div class="col-auto">
                                            <div class="stat text-primary">
                                                <i class="align-middle" data-feather="database"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <h1 class="mt-1 mb-3">{{ cards_data.experiments }}</h1>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col mt-0">
                                            <h5 class="card-title">Datasets</h5>
                                        </div>
                        
                                        <div class="col-auto">
                                            <div class="stat text-primary">
                                                <i class="align-middle" data-feather="hard-drive"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <h1 class="mt-1 mb-3">{{ cards_data.datasets }}</h1>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col mt-0">
                                            <h5 class="card-title">Users</h5>
                                        </div>
                        
                                        <div class="col-auto">
                                            <div class="stat text-primary">
                                                <i class="align-middle" data-feather="users"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <h1 class="mt-1 mb-3">{{ cards_data.users }}</h1>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col mt-0">
                                            <h5 class="card-title">Countries</h5>
                                        </div>
                                        <div class="col-auto">
                                            <div class="stat text-primary">
                                                <i class="align-middle" data-feather="map"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <h1 class="mt-1 mb-3">{{ cards_data.countries }}</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>            
        </div>
        <div class="row d-flex">
            <div class="col-xl-12 col-xxl-7">
                <div class="card flex-fill w-100">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Experiments performed in the last 7 days</h5>
                    </div>
                    <div class="card-body py-3">
                        <div class="chart chart-sm">
                            <canvas id="exp_7d_times"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-6 col-md-6 col-xxl-3 d-flex order-2 order-xxl-3">
                <div class="card flex-fill w-100">
                    <div class="card-header">

                        <h5 class="card-title mb-0">Desired Use</h5>
                    </div>
                    <div class="card-body d-flex">
                        <div class="align-self-center w-100">
                            <div class="py-3">
                                <div class="chart chart-xs">
                                    <canvas id="desired_use"></canvas>
                                </div>
                            </div>

                            <table class="table mb-0">
                                <tbody>
                                    {% for use in desired_use %}
                                        <tr>
                                            <td>{{ use }}</td>
                                            <td class="text-end">{{ desired_use[use] }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-6 col-xxl-6 d-flex order-3 order-xxl-2">
                <div class="card flex-fill w-100">
                    <div class="card-header">

                        <h5 class="card-title mb-0">Real-Time</h5>
                    </div>
                    <div class="card-body px-4">
                        <div id="world_map" style="height:350px;"></div>
                    </div>
                </div>
            </div>
            
        </div>

        <div class="row">
            <div class="col-12 col-lg-8 col-xxl-9 d-flex">
                <div class="card flex-fill">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Latest Experiments</h5>
                    </div>
                    <table class="table table-hover my-0">
                        <thead>
                            <tr>
                                <th>Algorithm type</th>
                                <th class="d-none d-xl-table-cell">Start Date</th>
                                <th class="d-none d-xl-table-cell">End Date</th>
                                <th>Status</th>
                                <th class="d-none d-md-table-cell">User</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exp in experiments %}
                            <tr>
                                <td>{{ exp.name }}</td>
                                <td class="d-none d-xl-table-cell">{{ exp.starttime }}</td>
                                <td class="d-none d-xl-table-cell">{{ exp.endtime }}</td>
                                <td>
                                    {% if exp.state == 0 %}
                                    <span class="badge bg-warning">In progress...</span>
                                    {% elif exp.state == 1 %}
                                    <span class="badge bg-success">Finalized</span>
                                    {% else %}
                                    <span class="badge bg-danger">Error</span>
                                    {% endif %}
                                </td>
                                <td class="d-none d-md-table-cell">{{ exp.user }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-12 col-lg-4 col-xxl-3 d-flex">
                <div class="card flex-fill w-100">
                    <div class="card-header">

                        <h5 class="card-title mb-0">All time datasets run</h5>
                    </div>
                    <div class="card-body d-flex w-100">
                        <div class="align-self-center chart chart-lg">
                            <canvas id="exp_times"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

{% endblock content %}

{% block js %}


<script>
    const CHART_COLORS = {
        ubu: 'rgb(170,34,60)',
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        grey: 'rgb(201, 203, 207)'            
        };
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        d3.csv("{{ url_for('static', filename='tmp/exp_7d.csv') }}")
            .then(makeChartExp7d);
        function makeChartExp7d(data){
            var ctx = document.getElementById("exp_7d_times").getContext("2d");
            var gradient = ctx.createLinearGradient(0, 0, 0, 225);
            gradient.addColorStop(0, "rgba(198, 40, 40, 1)");
            gradient.addColorStop(1, "rgba(198, 40, 40, 0)");
            var day = data.map(function (d) { return d.day; });
            var times = data.map(function (d) { return d.times; });
            maxValue = Math.max.apply(null, times);
            // Line chart
            new Chart(document.getElementById("exp_7d_times"), {
                type: "line",
                data: {
                    labels: day,
                    datasets: [{
                        label: "Experiments performed",
                        fill: true,
                        backgroundColor: gradient,
                        borderColor: CHART_COLORS.ubu,
                        data: times
                    }]
                },
                options: {
                    responsive: !window.MSInputMethodContext,
                    maintainAspectRatio: false,
                    legend: {
                        display: false
                    },
                    tooltips: {
                        intersect: false
                    },
                    hover: {
                        intersect: true
                    },
                    plugins: {
                        filler: {
                            propagate: false
                        }
                    },
                    scales: {
                        xAxes: [{
                            reverse: true,
                            gridLines: {
                                color: "rgba(0,0,0,0.0)"
                            }
                        }],
                        yAxes: [{
                            ticks: {
                                stepSize:Math.ceil(maxValue/2.5)
                            },
                            display: true,
                            borderDash: [3, 3],
                            gridLines: {
                                color: "rgba(0,0,0,0.0)"
                            }
                        }]
                    }
                }
            });
        }
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        d3.csv("{{ url_for('static', filename='tmp/unique_use.csv') }}")
        .then(makeUsePie)
        function makeUsePie(data){
            var use = data.map(function (d) { return d.use; });
            var times = data.map(function (d) { return d.times; });
            new Chart(document.getElementById("desired_use"), {
                type: "pie",
                data: {
                    labels: use,
                    datasets: [{
                        data: times,
                        backgroundColor: Object.values(CHART_COLORS),
                        borderWidth: 5
                    }]
                },
                options: {
                    responsive: !window.MSInputMethodContext,
                    maintainAspectRatio: false,
                    legend: {
                        display: false
                    },
                    cutoutPercentage: 0
                }
            });
        }
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        d3.csv("{{ url_for('static', filename='tmp/experiments.csv') }}")
             .then(makeChartExpTotal);
        function makeChartExpTotal(data) {
            var dataset = data.map(function (d) { return d.dataset; });
            var times = data.map(function (d) { return d.times; });
            

            new Chart(document.getElementById("exp_times"), {
                type: "bar",
                data: {
                    labels: dataset,
                    datasets: [{
                        label: "Total times used",
                        backgroundColor: CHART_COLORS.ubu,
                        borderColor: CHART_COLORS.ubu,
                        hoverBackgroundColor: CHART_COLORS.ubu,
                        hoverBorderColor: CHART_COLORS.ubu,
                        data: times,
                        barPercentage: .75,
                        categoryPercentage: .5
                    }]
                },
                options: {
                    responsive: !window.MSInputMethodContext,
                    maintainAspectRatio: false,
                    legend: {
                        display: false
                    },
                    scales: {
                        yAxes: [{
                            gridLines: {
                                display: false
                            },
                            stacked: false,
                            ticks: {
                                stepSize: 20
                            }
                        }],
                        xAxes: [{
                            ticks: {
                                color: 'red',
                            },
                            stacked: false,
                            display: false,
                            gridLines: {
                                color: "transparent"
                            }
                        }]
                    }
                }
            });
        }
    });
</script>
<script>
    
    document.addEventListener("DOMContentLoaded", function () {
        d3.csv("{{ url_for('static', filename='tmp/countries.csv') }}")
            .then(makeMap);
        function makeMap(data) {   
            var markers = [];
            data.forEach(d => {
                markers.push({
                    coords:[d.latitude, d.longitude],
                    name: d.name,
                    user: d.users
                });
            });
            
            var map = new jsVectorMap({
                map: "world",
                selector: "#world_map",
                normalizeFunction: 'polynomial',
                draggable: true,
                zoomButtons: true,
                zoomOnScroll: true,
                zoomOnScrollSpeed: 3,
                zoomMax: 12,
                zoomMin: 1,
                zoomAnimate: true,
                markers: markers,
                markerStyle: {
                    initial: {
                        r: 9,
                        strokeWidth: 7,
                        stokeOpacity: .4,
                        fill: CHART_COLORS.ubu
                    },
                    hover: {
                        fill: CHART_COLORS.ubu,
                        stroke: CHART_COLORS.ubu,
                    }
                },
                onMarkerTooltipShow: function (tooltip,  index) {
                    tooltip.selector.innerHTML = '<b>' + tooltip.text() + '<br>Users: ' + markers[index].user + '</b>';
                }
            });
            window.addEventListener("resize", () => {
                map.updateSize();
            });
        }
    });
</script>
{% endblock js%}